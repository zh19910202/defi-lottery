# DeFi Lottery

一个基于以太坊的去中心化彩票系统，结合DeFi收益和随机抽奖功能。

## 项目背景

DeFi Lottery的诞生源于一个流传已久的有趣段子：

> 组织一群人，每人出资1万元，然后将这些钱存入银行，将这个月的利息全部分配给出资人中的一位幸运儿。下个月，再选另一位幸运儿获得利息，如此循环往复。通过这种方式，我们可以源源不断地创造幸运儿，让普通人有机会体验"一夜暴富"的感觉，同时所有人的本金都安全无虞。

然而，在现实世界中，这个创意往往难以实施：

- 组织者可能携款跑路
- 难以保证随机抽取的公平性
- 缺乏透明度和可信任的执行机制
- 法律和监管限制

区块链技术和智能合约的出现彻底改变了这一局面。DeFi Lottery将这个民间创意转化为现实，通过以下方式解决传统障碍：

- 资金由智能合约托管，无需信任中间人
- 使用Chainlink VRF提供可验证的随机性
- 所有交易和抽奖过程在链上完全透明
- 代码开源，规则明确且不可更改
- 结合DeFi协议产生更高的收益率

DeFi Lottery让这个曾经只是段子的创意在区块链世界成为现实，为用户提供了一种新颖、安全、公正的参与方式。

## 项目概述

DeFi Lottery是一个创新的区块链彩票系统，用户可以存入WETH代币参与定期抽奖。与传统彩票不同，本系统具有以下特点：

- 用户资金始终由智能合约保管，确保安全性和透明度
- 闲置资金通过DeFi协议（如Compound）产生收益，增加奖池规模
- 使用权益代币（ShareToken）代表用户在系统中的份额
- 基于Chainlink VRF实现可验证的随机抽奖
- 模块化设计，各组件职责明确，便于升级和维护
- **仅中奖者获取收益**：用户的收益只能通过中奖获取，撤回存款仅返还原始本金

## 系统架构

系统由5个核心合约组成，每个合约负责特定功能：

### 1. Vault（保险库合约）

- 管理用户存款和提款
- 铸造和销毁权益代币
- 计算用户的幸运值权重
- 与收益聚合器交互，将资金投入DeFi协议

### 2. Lottery（彩票合约）

- 管理彩票的轮次
- 通过Chainlink VRF生成随机数
- 执行抽奖逻辑，确定中奖者
- 维护用户权重的排序求和树

### 3. PrizePool（奖池合约）

- 管理奖池资金
- 处理奖金发放
- 收取系统费用并再投资
- 跟踪奖池余额

### 4. LotteryRouter（路由合约）

- 用户交互的统一入口
- 协调不同合约间的调用
- 简化用户操作流程
- 提供状态查询功能

### 5. YieldAggregator（收益聚合器合约）

- 对接Compound等DeFi协议
- 优化收益策略
- 管理WETH代币的存取
- 提供余额查询

## 用户流程

### 存款

1. 用户授权Router合约使用其WETH代币
2. 调用Router.deposit()方法存入WETH
3. 用户获得等额的ShareToken作为权益证明
4. 系统计算用户的幸运值权重

### 抽奖

1. 每30天自动进行一次抽奖（也可由管理员手动触发）
2. 系统基于用户的幸运值权重随机选出获胜者
3. 获胜者可领取当期奖池中的大部分资金（约95%）
4. 剩余部分作为系统费用再投资，提高下期奖池规模

### 提款

1. 用户将ShareToken转移到Vault合约
2. 调用Router.withdraw()或Router.withdrawFromRound()方法
3. 系统销毁ShareToken，从收益聚合器提取对应的WETH
4. 用户收到WETH代币
5. **重要说明**：提款只返还用户最初存入的本金，不包含任何收益。系统产生的所有收益都归入奖池，只有中奖者才能获取收益

## 技术特点

- **权重计算**：存款金额和时间共同决定用户的中奖概率
- **随机性保障**：使用Chainlink VRF实现链上可验证的随机数
- **资金安全**：模块化权限管理，杜绝中心化风险
- **代码优化**：使用非重入锁、事件日志等最佳实践
- **可升级设计**：使用代理模式，支持合约升级
- **收益分配机制**：所有DeFi收益集中到奖池，提高中奖奖励，激励长期参与

## 开发设置

### 前提条件

- Node.js (v14+)
- npm或yarn
- Hardhat

### 安装依赖

```bash
npm install
```

### 编译合约

```bash
npx hardhat compile
```

### 测试

```bash
npx hardhat test
```

### 部署

1. 设置环境变量（参见.env.example）
2. 运行部署脚本

```bash
npx hardhat run scripts/deploy.js --network <network-name>
```

## 安全注意事项

- Vault合约设计为抽象合约，需要实现具体实现才能部署
- 系统已转为使用WETH而非原生ETH，提高了与DeFi生态的兼容性
- 所有关键操作都有权限控制和事件日志
- 存款金额有合理上下限（0.1-1 ETH），防止鲸鱼操纵
- 取款操作要求提供权益代币作为凭证，确保资金安全

## 许可证

MIT

## 免责声明

本项目仅用于教育和研究目的，使用前请自行评估风险。未经完整审计，不建议用于生产环境。
